var Bullet,EFFECTS,EMPTY,GameOverStage,Images,LeftPlayer,Mode,Monster,MonsterSpawner,Player,RANDOM_TILES,RightPlayer,SplitStage,SplitTileMap,i,j,extend=function(t,e){function i(){this.constructor=t}for(var s in e)hasProp.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,bind=function(t,e){return function(){return t.apply(e,arguments)}};for(EFFECTS={fillText3D:function(t,e,i,s,n){return i.save(),i.translate(s,n),i.font=e,i.fillStyle="red",i.fillText(t,-3,2),i.fillStyle="blue",i.fillText(t,3,2),i.fillStyle="#000000",i.fillText(t,0,0),i.restore()}},Images={HEART:"heart",HEART_DATA:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAA Bzenr0AAAAwElEQVRYR+2WSw6AIAxEy/0PjcGkpGIr/ahlgWun8xwQpkDyU5 L94RGgAlQOsACvs77fZt8ApCEjyAjh1XUA7QAKghARbQggsn8Q/gTwfEHEHL UNomSZd4gNsBPYCaSfAxtgiQQyIC6X0RIAf0LQMuNuRN7reGxSbCf86nTkuq RYSt+GkIqsqxVb45fM2VY8Do8m8WSuAoj8HTNzNYAHQmNuAsClmS2J1pg0Y+ uWkmu81dyVAMXFNDzGoQTsmcmKA+7qQBPPVyQkAAAAAElFTkSuQmCC",TILES:"tiles",TILES_DATA:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAA Bzenr0AAAAoklEQVRYR+2VUQqAIAyG8yKB97+Qb0IXKSYMxjBZ5ibKeqkHNz 9/7FtIKd3HxCcAQIxnF0LOV6n7U28KAMAAS9+mAJAWbo7f5gAUAmCmAOCFcw BPYI0EuDyoMtVMWDNWTbdqAFwWb65XBZBMp2EAks201hQVazWX9N1rFtBRKz n9GiJqnYT/BS1p1fp4AvslILn5fJjt5QFPwBPoTuBr4cj1DyDKSRC8Z4KSAA AAAElFTkSuQmCC",PORTAL:"portal",PORTAL_DATA:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAEgCAYAAA DVDXFAAAABe0lEQVR4Xu3dQRLBMBgG0DqCK9i5kOPIpMdxITtXcASmpR2ihC hq5lkhzZ/PkzTdZVYVvmKMh8uuIYRZSam2U1qspFBJnya0AAQI3Agsw7pdUf uSdfWgz/zcto11f9XgMpxsgN2LIovk+rcFBJicQBoo/c8/PgcEIDCqQHPT2l SHq2e8dC9IBywN0N0gV9Xpaax/kBSAAAECBAgQIECAAAECBAgQIECAAAECBA gQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBA gQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBA gQIECAAAECBAgQIECAAAECBAgQIECAAIGfCsQY+zPPl2HdHk3+qXPPt7Hujj 6vQginw88FIPCXAv1UvvNmkXw/P38ebRUI8HWB3IC59rfnQG6AXPvTAXKFxm wf3AvGHCBXSwAC0xHIzdah9ssdtGlvfk1JnSMv4vF75/xKqwAAAABJRU5Erk Jggg==",P1:"player1",P1_DATA:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAYAAA DtwH1UAAAClElEQVRoQ+1aUZLCIAylJ2hvt1xCb+CXR/AS7u3aE7ADayoNCQ ktOtNSxy9NeeS9JIZgZwpezhhXYG4649/1XkfEzxJEOvx86hi1NrErFaQFfF KAheNawiVZIkEkIVrCTwSYna9FPBbmJQQnQmv4CwGqOh+XICwmI0KL+NsF4I iGz6lMqinAzvFTAUpLD0d0LgN8WbI26ZJCBjSGX08AT2oJebUF2Cn+9hIkdT /U9zVL0M7xzy4ICVi1EVAE33kOIEj65jnkPAlnStg3TuJZAfq+D7Of+/0etn m5Xosq7tD3ZpqmBMOvS32OF28BnxQAHAfyL5dLEfHe+PF4mNvtlggAa+cEaA l/IQB2PEQ9In8YhmIxqAe4zADbOesOjj8LkKQ7EfW1yAeSYxFaxV8IQEUdlJ IqYY8WwQK0iJ8IEJec2hGPRaQEaA0/CBCn/6dqfkw+rv8t44sCeOJ8JozTlM 56rDW+1RzHcRncXUfacncAOQGOjp/8CHuHF4R6MrlBFyGAN3dwFQzDOeESJs 7C1vDJQ1IczmTke4MX+dOEov81FP2xy6Wla0jAjFvhIAaVeQfCZ0/CQEQgAG eAteb3mf+DxH/QQ/qU91Ct4At/G3EOqkgc0UC+J5m7Anjfx6wXwZjj42cEcC HEMzeKc1jnRVgrQBv4WQF0xGqIWiPCO/pxAYvLG/7N0I49pKIorftupbf5Lw 7juI1yvbzWPkeA5Lx/FvA1trG9RDzuyHT+ONf3+RkZN3wUu6Dchj9BgpZQIF Vrrxl/c52YlFVb9nAKQLCrIZQaJErZRQXB7gXQlIyS6F+znkYwrgxWEUCzaW 0d1jqD1+OeKyVfKkPcepp9qzJA2oBEZC0icg6tJVUqETW+L/X/DwgFwz+ZMT uKAAAAAElFTkSuQmCC",P2:"player2",P2_DATA:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAYAAA DtwH1UAAACiElEQVRoQ+2aYXaDIAzH8QR6u/USPUI/9Qb1Et3t9AT0RY0FJC ThabeCfNnbjPwlPxIIrDGiZq3IbDVqGp09Z12uPuGo7YCfT85J8/PLJWanBV KPfgDgPXCpwzksPhAORH36DoB58Hs5PgTzBkFBqFN/ARAfvDt79wBDQ6hXPw nAzekugFwwWgA16K8AYjM85Wh8po2M+b0wDVlbq34SALXA5kbAe0bLANSgz6 YgbpejeZ6TgjT9c7b/Uf/cBa3U/mYXdtYBXth8vg45K+Fo3vpcJb4CaNvWju O4ATL/feDSq/f88ein32+32/Qz1m/YYa36HoCYs8Ax9/vdXK9XFQQw7vt+hc CBAJ0a9TcA1F4OXhgGP1oAghsNFAgEUJv+BGCvwaPzQggYDVRaqln/EAAIIk xdbjS468LeAL5J/1AAsYjAdeETAL5B39v1HDETY2sCtTuqUZ+sA8LDMSjjw9 1x13UGtqgx27btDLUW8NvT7eFcqfrJQgwdi2co1jQeBQoAhP76jnObDPbY0r WBfyxQsn7i8tyf7/b5G73w7do2GgUIASLBbZKibLavQ1/03wvWGMvdVTaXH8 8EZy0CkDt+WwmUrM8CmAYPjbp5AU8vzwACtililjBoDOSuvFa6PuuY5OwL/w clca2VC6F0/SSA5OxbnI+O5RyVA0CyLcXUdoS+Zvzct1IpmASg7ZCzp86AqM Qk6c/tU2KvWYe4/oZxhLyqOkuL6UcBcOLhVlJqr4Eg7RMGJbWV6kv701bzJw DF3YRky1A0AHAANxPRAZydtg6R9hfOaO69XSNAS19WAW/nHTWoI/U5R6ZSme R73VGqF+HUQpb6cM0CKAn/mM2e+lpH5n7zCzmOFk5rUnzaAAAAAElFTkSuQm CC"},Loader.loadImage(Images.TILES,Images.TILES_DATA),Loader.loadImage(Images.PORTAL,Images.PORTAL_DATA),Loader.loadImage(Images.P1,Images.P1_DATA),Loader.loadImage(Images.P2,Images.P2_DATA),SplitTileMap=function(t){function e(t,i,s,n,o){e.__super__.constructor.call(this,2*t,2*i,s/2,n,o)}return extend(e,t),e.prototype._render=function(){var t,e,i,s,n,o,r,h,a,l,u;for(e=Loader.getImage(Images.TILES),o=[],t=i=0,n=this.cols;0<=n?i<=n:i>=n;t=0<=n?++i:--i)o.push(function(){var i,n,o;for(o=[],s=i=0,n=this.rows;0<=n?i<=n:i>=n;s=0<=n?++i:--i)r=this.getTile(t,s),h=t*this.tileSize,l=s*this.tileSize,a=0,u=0,0===r?(a=0,u=0):(r=1)?(a=1,u=0):(r=2)?(a=0,u=1):(r=3)&&(a=1,u=1),this.ctx.save(),this.ctx.drawImage(e,a*this.tileSize,u*this.tileSize,this.tileSize,this.tileSize,h,l,this.tileSize,this.tileSize),o.push(this.ctx.restore());return o}.call(this));return o},e}(TileMap),EMPTY=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],RANDOM_TILES=[],i=j=0;j<=179;i=++j)RANDOM_TILES.push(Math.round(3*Math.random()));SplitStage=function(t){function e(t,i,s){this.testBulletCollisions=bind(this.testBulletCollisions,this),this._update=bind(this._update,this),this._init=bind(this._init,this),e.__super__.constructor.call(this,t,i-e.gutterHeight,s)}return extend(e,t),e.tileWidth=32,e.wallWidth=e.tileWidth,e.gutterHeight=e.tileWidth,e.prototype._init=function(){var t,i;return t=this.width/e.tileWidth,i=this.height/e.tileWidth,this.tilemap=new SplitTileMap(t,i,e.tileWidth,RANDOM_TILES,this.ctx),this.wall=new Box(new Vector(this.width/2-e.wallWidth/2,0),e.wallWidth,this.height).toPolygon(),this.lives=3,this.leftPlayer=new LeftPlayer(30,this.height/2),this.addActor(this.leftPlayer),this.rightPlayer=new RightPlayer(610,this.height/2),this.addActor(this.rightPlayer),this.monsterSpawner=new MonsterSpawner(this.width/2,this.height/2),this.addActor(this.monsterSpawner)},e.prototype._render=function(){return this.tilemap.render(),this.drawWall(),this.drawGutter()},e.prototype._update=function(t){var e,i,s,n,o;if(this.lives<=0)return void(this.state=STATE.finished);for(this.testBulletCollisions(),n=[],o=this.actors,i=0,s=o.length;i<s;i++)e=o[i],e.shouldDestroy()||n.push(e);return this.actors=n},e.prototype.drawWall=function(){var t,i;return i=Loader.getImage(Images.PORTAL),t=this.getContext(),t.save(),t.drawImage(i,this.wall.pos.x,this.wall.pos.y,e.wallWidth,this.height),t.restore()},e.prototype.drawGutter=function(){var t,i,s;return t=this.getContext(),t.fillStyle="#000000",t.fillRect(0,this.height,this.width,this.height+e.gutterHeight),i=11,s=22,t.fillStyle="White",t.font="normal 12pt Arial",t.fillText("Anomalies resolved: "+this.leftPlayer.score,i,this.height+s),t.save(),t.scale(-1,1),t.fillStyle="White",t.font="normal 12pt Arial",t.fillText("Anomalies resolved: "+this.rightPlayer.score,-this.width+i,this.height+s),t.restore()},e.prototype.testBulletCollisions=function(){var t,e,i,s,n,o,r,h,a,l,u,d,c,A;for(e=this.actors.filter(this.isInstanceOfBullet),o=0,h=e.length;o<h;o++)t=e[o],i=SAT.testCirclePolygon(t.body,this.wall),i&&(t.destroy=!0);for(c=this.actors.filter(this.isInstanceOfMonster),A=[],r=0,a=c.length;r<a;r++){for(d=c[r],u=0,l=e.length;u<l;u++)t=e[u],i=SAT.testCircleCircle(t.body,d.body),i&&(t.firedBy instanceof Player&&t.firedBy.addScore(1),t.destroy=!0,d.destroy=!0);s=SAT.testCircleCircle(this.leftPlayer.body,d.body),n=SAT.testCircleCircle(this.rightPlayer.body,d.body),(s||n)&&(this.lives--,d.destroy=!0),this.isCircleInBounds(d.body)?A.push(void 0):(this.lives--,A.push(d.destroy=!0))}return A},e.prototype.isInstanceOfBullet=function(t){return t instanceof Bullet},e.prototype.isInstanceOfMonster=function(t){return t instanceof Monster},e}(Stage),GameOverStage=function(t){function e(t,i,s){this._update=bind(this._update,this),this._init=bind(this._init,this),e.__super__.constructor.call(this,t,i,s),this.controller=Controller.get()}return extend(e,t),e.prototype._init=function(){return this.gameOverText="GAME OVER",this.retryText="Hit ENTER restart reality.",this.background=this.getNoise()},e.prototype._update=function(t){if(this.controller.isPressed(Keys.ENTER))return this.state=STATE.finished},e.prototype._render=function(){return this.ctx.save(),this.background=this.getNoise(),this.ctx.putImageData(this.background,0,0),EFFECTS.fillText3D(this.gameOverText,"72px Georgia",this.ctx,80,120),EFFECTS.fillText3D(this.retryText,"42px Georgia",this.ctx,40,200),this.ctx.restore()},e.prototype.getNoise=function(){var t,e;for(e=this.ctx.createImageData(this.width,this.height),i=0;i<e.data.length;)t=100*Math.random()|0,e.data[i++]=0,e.data[i++]=0,e.data[i++]=0,e.data[i++]=t;return e},e}(Stage),Monster=function(t){function e(t,i,s,n){null==s&&(s=0),this.color=null!=n?n:"#00FF00",e.__super__.constructor.call(this,t,i,s,16),this.speed=Math.round(2*Math.random())+3}return extend(e,t),e.prototype._render=function(){return this.drawDebug(this.color)},e.prototype._update=function(t){var e,i,s;return s=t/100,e=this.speed*s,i=new Vector(e,0),i.rotate(this.direction),this.position.add(i),this.updateBody()},e}(CircleActor),Mode={MIRROR:0,FLIPPED:1,VARIANCE:2},MonsterSpawner=function(t){function e(t,i){this.updateMode=bind(this.updateMode,this),this._update=bind(this._update,this),e.__super__.constructor.call(this,t,i),this.mode=Mode.MIRROR,this.spawnTimer=new Timer(2e3),this.modeTimer=new Timer(1e4)}return extend(e,t),e.prototype._update=function(t){if(this.spawnTimer.tick(t),this.modeTimer.tick(t),this.spawnTimer.hasEnded()&&(this.spawnTimer.restart(),this.spawnMonsters()),this.modeTimer.hasEnded())return this.modeTimer.restart(),this.updateMode()},e.prototype.spawnMonsters=function(){var t,e,i,s;switch(e=20,t=this.stage.height-2*e,i=0,s=0,this.mode){case Mode.MIRROR:i=s=Math.floor(Math.random()*t)+e;break;case Mode.FLIPPED:i=Math.floor(Math.random()*t)+e,s=this.stage.height-i;break;case Mode.VARIANCE:i=Math.floor(Math.random()*t)+e,s=Math.floor(Math.random()*t)+e;break;default:i=s=Math.floor(Math.random()*t)+e}return this.stage.addActor(new Monster(this.stage.width/2,i,0,"#FF0000")),this.stage.addActor(new Monster(this.stage.width/2,s,MathHelpers.toRadians(180),"#0000FF"))},e.prototype.updateMode=function(){var t,e;return e=[Mode.MIRROR,Mode.FLIPPED,Mode.VARIANCE],e.splice(this.mode,1),t=Math.floor(Math.random()*e.length),this.mode=e[t]},e}(Actor),Player=function(t){function e(t,i){this.addScore=bind(this.addScore,this),e.__super__.constructor.call(this,t,i,0,16),this.controller=Controller.get(),this.velx=0,this.vely=0,this.maxSpeed=5,this.score=0}return extend(e,t),e.prototype.addScore=function(t){return this.score+=t},e.prototype._render=function(){return this.drawDebug()},e}(CircleActor),LeftPlayer=function(t){function e(t,i){this._update=bind(this._update,this),e.__super__.constructor.call(this,t,i),this.reloadTimer=new Timer(500)}return extend(e,t),e.prototype._render=function(){var t;return t=this.stage.getContext(),t.save(),this.drawDebug(),t.restore()},e.prototype._update=function(t){var e,i,s,n,o,r;return this.reloadTimer.tick(t),o=this.position.x,r=this.position.y,n=t/100,i=100,e=2,this.controller.isPressed(Keys.D)||this.reloadTimer.end(),this.reloadTimer.hasEnded()&&this.controller.isPressed(Keys.D)&&(this.reloadTimer.restart(),this.stage.addActor(new Bullet(this.position.x+10,this.position.y,this.direction,this))),this.controller.isPressed(Keys.W)?this.vely>-this.maxSpeed&&(this.vely-=e*n,this.vely<-this.maxSpeed&&(this.vely=-this.maxSpeed)):this.vely<0&&(this.vely+=i*n,this.vely>0&&(this.vely=0)),this.controller.isPressed(Keys.S)?this.vely<this.maxSpeed&&(this.vely+=e*n,this.vely>this.maxSpeed&&(this.vely=this.maxSpeed)):this.vely>0&&(this.vely-=i*n,this.vely<0&&(this.vely=0)),s=new Circle(new Vector(o,r+this.vely),this.radius),this.stage.isCircleInBounds(s)&&this.setPosition(o,r+this.vely),this.updateBody()},e}(Player),RightPlayer=function(t){function e(t,i){this._update=bind(this._update,this),e.__super__.constructor.call(this,t,i),this.direction=MathHelpers.toRadians(180),this.reloadTimer=new Timer(500)}return extend(e,t),e.prototype._render=function(){return this.drawDebug("#0000FF")},e.prototype._update=function(t){var e,i,s,n,o,r;return this.reloadTimer.tick(t),o=this.position.x,r=this.position.y,n=t/100,i=100,e=2,this.controller.isPressed(Keys.LEFT)||this.reloadTimer.end(),this.reloadTimer.hasEnded()&&this.controller.isPressed(Keys.LEFT)&&(this.reloadTimer.restart(),this.stage.addActor(new Bullet(this.position.x-10,this.position.y,this.direction,this))),this.controller.isPressed(Keys.UP)?this.vely>-this.maxSpeed&&(this.vely-=e*n,this.vely<-this.maxSpeed&&(this.vely=-this.maxSpeed)):this.vely<0&&(this.vely+=i*n,this.vely>0&&(this.vely=0)),this.controller.isPressed(Keys.DOWN)?this.vely<this.maxSpeed&&(this.vely+=e*n,this.vely>this.maxSpeed&&(this.vely=this.maxSpeed)):this.vely>0&&(this.vely-=i*n,this.vely<0&&(this.vely=0)),s=new Circle(new Vector(o,r+this.vely),this.radius),this.stage.isCircleInBounds(s)&&this.setPosition(o,r+this.vely),this.updateBody()},e}(Player),Bullet=function(t){function e(t,i,s,n){null==s&&(s=0),this.firedBy=n,e.__super__.constructor.call(this,t,i,s,5),this.bulletSpeed=120}return extend(e,t),e.prototype._render=function(){return this.drawDebug("#00FF00")},e.prototype._update=function(t){var e,i,s;return s=t/100,i=this.bulletSpeed*s,e=new Vector(i,0),e.rotate(this.direction),this.position.add(e),this.stage.isCircleInBounds(this.body)||(this.destroy=!0),this.updateBody()},e}(CircleActor);