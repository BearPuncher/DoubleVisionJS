var Bullet,LeftPlayer,Mode,Monster,MonsterSpawner,Player,RightPlayer,SplitStage,SplitTileMap,TILES,extend=function(t,e){function i(){this.constructor=t}for(var s in e)hasProp.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,bind=function(t,e){return function(){return t.apply(e,arguments)}};SplitTileMap=function(t){function e(t,i,s,r,o){e.__super__.constructor.call(this,t,i,s,r,o),Loader.loadImage(e.tile,e.tiledata)}return extend(e,t),e.tile="tile",e.tiledata="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA wElEQVRYR+2XwQ3AIAhF6wbuv5EjuIUbtNHExloUUBI50Gv98IwgXxdjvFNK18rnvS+yHb 0LIdw5EDdIq9nRF4C8C04QaO2q/gWgQswSUSD6NR8ADGIlQVtbkP4HMIKgJK/JOEcEAvQQ nOQQxEw/BKgQu22G6fUCSPU5Vtj6ilC6z1ltSKl2aUAdVzFl5/20lCpSd3wcHwcwP1ANCX ZjzSYd5d9ojfkB8wPmB8wP6HmYcEYyx/dDj95Wf/5xenocP9OrvDDCnV6DAAAAAElFTkSu QmCC",e.prototype._render=function(){var t,i,s,r,o,n,h,a;if(n=Loader.getImage(e.tile),null!=n){for(o=[],t=i=0,r=this.cols;0<=r?i<=r:i>=r;t=0<=r?++i:--i)o.push(function(){var i,r,o;for(o=[],s=i=0,r=this.rows;0<=r?i<=r:i>=r;s=0<=r?++i:--i)n=this.getTile(t,s),h=t*this.tileSize,a=s*this.tileSize,0===n?o.push(this.ctx.drawImage(Loader.getImage(e.tile),h,a)):(this.ctx.fillStyle="#000000",o.push(this.ctx.fillRect(h,a,this.tileSize,this.tileSize)));return o}.call(this));return o}},e}(TileMap),TILES=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],SplitStage=function(t){function e(t,i,s){this._update=bind(this._update,this),this._init=bind(this._init,this),e.__super__.constructor.call(this,t,i-e.gutterHeight,s)}return extend(e,t),e.tileWidth=32,e.wallWidth=e.tileWidth,e.gutterHeight=e.tileWidth,e.prototype._init=function(){var t,i;return t=this.width/e.tileWidth,i=this.height/e.tileWidth,this.tilemap=new SplitTileMap(t,i,e.tileWidth,TILES,this.ctx),this.wall=new Box(new Vector(this.width/2-e.wallWidth/2,0),e.wallWidth,this.height).toPolygon(),this.leftPlayer=new LeftPlayer(30,this.height/2),this.addActor(this.leftPlayer),this.rightPlayer=new RightPlayer(610,this.height/2),this.addActor(this.rightPlayer),this.monsterSpawner=new MonsterSpawner(this.width/2,this.height/2),this.addActor(this.monsterSpawner)},e.prototype._render=function(){return this.tilemap.render(),this.drawWall(),this.drawGutter()},e.prototype._update=function(t){var e,i,s,r,o;for(this.testBulletCollisions(),r=[],o=this.actors,i=0,s=o.length;i<s;i++)e=o[i],e.shouldDestroy()||r.push(e);return this.actors=r},e.prototype.drawWall=function(){var t;if(null!=this.wall)return t=this.getContext(),t.fillStyle="#000000",t.fillRect(this.wall.pos.x,this.wall.pos.y,e.wallWidth,this.height)},e.prototype.drawGutter=function(){var t,i,s;return t=this.getContext(),t.fillStyle="#000000",t.fillRect(0,this.height,this.width,this.height+e.gutterHeight),i=11,s=22,t.fillStyle="White",t.font="normal 12pt Arial",t.fillText("Anomalies resolved: "+this.leftPlayer.score,i,this.height+s),t.save(),t.scale(-1,1),t.fillStyle="White",t.font="normal 12pt Arial",t.fillText("Anomalies resolved: "+this.rightPlayer.score,-this.width+i,this.height+s),t.restore()},e.prototype.testBulletCollisions=function(){var t,e,i,s,r,o,n,h,a,l;for(e=this.actors.filter(this.isInstanceOfBullet),s=0,o=e.length;s<o;s++)t=e[s],i=SAT.testCirclePolygon(t.body,this.wall),i&&(t.destroy=!0);for(a=this.actors.filter(this.isInstanceOfMonster),l=[],r=0,n=a.length;r<n;r++)h=a[r],l.push(function(){var s,r,o;for(o=[],s=0,r=e.length;s<r;s++)t=e[s],i=SAT.testCircleCircle(t.body,h.body),i?(t.firedBy instanceof Player&&t.firedBy.addScore(1),t.destroy=!0,o.push(h.destroy=!0)):o.push(void 0);return o}());return l},e.prototype.isInstanceOfBullet=function(t){return t instanceof Bullet},e.prototype.isInstanceOfMonster=function(t){return t instanceof Monster},e}(Stage),Monster=function(t){function e(t,i,s,r){null==s&&(s=0),this.color=null!=r?r:"#00FF00",e.__super__.constructor.call(this,t,i,s,16),this.speed=4}return extend(e,t),e.prototype._render=function(){return this.drawDebug(this.color)},e.prototype._update=function(t){var e,i,s;return s=t/100,e=this.speed*s,i=new Vector(e,0),i.rotate(this.direction),this.position.add(i),this.stage.isCircleInBounds(this.body)||(this.destroy=!0),this.updateBody()},e}(CircleActor),Mode={MIRROR:0,FLIPPED:1,VARIANCE:2},MonsterSpawner=function(t){function e(t,i){this.updateMode=bind(this.updateMode,this),this._update=bind(this._update,this),e.__super__.constructor.call(this,t,i),this.mode=Mode.MIRROR,this.spawnTimer=new Timer(2e3),this.modeTimer=new Timer(1e4)}return extend(e,t),e.prototype._update=function(t){if(this.spawnTimer.tick(t),this.modeTimer.tick(t),this.spawnTimer.hasEnded()&&(this.spawnTimer.restart(),this.spawnMonsters()),this.modeTimer.hasEnded())return this.modeTimer.restart(),this.updateMode()},e.prototype.spawnMonsters=function(){var t,e,i,s;switch(e=15,t=this.stage.height-2*e,i=0,s=0,this.mode){case Mode.MIRROR:i=s=Math.floor(Math.random()*t)+e;break;case Mode.FLIPPED:i=Math.floor(Math.random()*t)+e,s=this.stage.height-i;break;case Mode.VARIANCE:i=Math.floor(Math.random()*t)+e,s=Math.floor(Math.random()*t)+e;break;default:i=s=Math.floor(Math.random()*t)+e}return this.stage.addActor(new Monster(this.stage.width/2,i,0,"#FF0000")),this.stage.addActor(new Monster(this.stage.width/2,s,MathHelpers.toRadians(180),"#0000FF"))},e.prototype.updateMode=function(){var t,e;return e=[Mode.MIRROR,Mode.FLIPPED,Mode.VARIANCE],e.splice(this.mode,1),t=Math.floor(Math.random()*e.length),this.mode=e[t]},e}(Actor),Player=function(t){function e(t,i){this.addScore=bind(this.addScore,this),e.__super__.constructor.call(this,t,i,0,16),this.controller=Controller.get(),this.velx=0,this.vely=0,this.maxSpeed=4,this.score=0}return extend(e,t),e.prototype.addScore=function(t){return this.score+=t},e.prototype._render=function(){return this.drawDebug()},e}(CircleActor),LeftPlayer=function(t){function e(t,i){this._update=bind(this._update,this),e.__super__.constructor.call(this,t,i),this.reloadTimer=new Timer(500)}return extend(e,t),e.prototype._render=function(){return this.drawDebug()},e.prototype._update=function(t){var e,i,s,r,o,n;return this.reloadTimer.tick(t),o=this.position.x,n=this.position.y,r=t/100,i=1.5,e=2,this.reloadTimer.hasEnded()&&this.controller.isPressed(Keys.D)&&(this.reloadTimer.restart(),this.stage.addActor(new Bullet(this.position.x+10,this.position.y,this.direction,this))),this.controller.isPressed(Keys.W)?this.vely>-this.maxSpeed&&(this.vely-=e*r,this.vely<-this.maxSpeed&&(this.vely=-this.maxSpeed)):this.vely<0&&(this.vely+=i*r,this.vely>0&&(this.vely=0)),this.controller.isPressed(Keys.S)?this.vely<this.maxSpeed&&(this.vely+=e*r,this.vely>this.maxSpeed&&(this.vely=this.maxSpeed)):this.vely>0&&(this.vely-=i*r,this.vely<0&&(this.vely=0)),s=new Circle(new Vector(o,n+this.vely),this.radius),this.stage.isCircleInBounds(s)&&this.setPosition(o,n+this.vely),this.updateBody()},e}(Player),RightPlayer=function(t){function e(t,i){this._update=bind(this._update,this),e.__super__.constructor.call(this,t,i),this.direction=MathHelpers.toRadians(180),this.reloadTimer=new Timer(500)}return extend(e,t),e.prototype._render=function(){return this.drawDebug("#0000FF")},e.prototype._update=function(t){var e,i,s,r,o,n;return this.reloadTimer.tick(t),o=this.position.x,n=this.position.y,r=t/100,i=1.5,e=2,this.reloadTimer.hasEnded()&&this.controller.isPressed(Keys.LEFT)&&(this.reloadTimer.restart(),this.stage.addActor(new Bullet(this.position.x-10,this.position.y,this.direction,this))),this.controller.isPressed(Keys.UP)?this.vely>-this.maxSpeed&&(this.vely-=e*r,this.vely<-this.maxSpeed&&(this.vely=-this.maxSpeed)):this.vely<0&&(this.vely+=i*r,this.vely>0&&(this.vely=0)),this.controller.isPressed(Keys.DOWN)?this.vely<this.maxSpeed&&(this.vely+=e*r,this.vely>this.maxSpeed&&(this.vely=this.maxSpeed)):this.vely>0&&(this.vely-=i*r,this.vely<0&&(this.vely=0)),s=new Circle(new Vector(o,n+this.vely),this.radius),this.stage.isCircleInBounds(s)&&this.setPosition(o,n+this.vely),this.updateBody()},e}(Player),Bullet=function(t){function e(t,i,s,r){null==s&&(s=0),this.firedBy=r,e.__super__.constructor.call(this,t,i,s,5),this.bulletSpeed=120}return extend(e,t),e.prototype._render=function(){return this.drawDebug("#00FF00")},e.prototype._update=function(t){var e,i,s;return s=t/100,i=this.bulletSpeed*s,e=new Vector(i,0),e.rotate(this.direction),this.position.add(e),this.stage.isCircleInBounds(this.body)||(this.destroy=!0),this.updateBody()},e}(CircleActor);